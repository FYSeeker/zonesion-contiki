/*********************************************************************************************
* 文件：bodyfat.c
* 作者：zonesion
* 说明：身体脂肪计算函数
* 修改：fuyou 2018.8.21 优化代码风格
* 注释：
*********************************************************************************************/

/*********************************************************************************************
* 头文件
*********************************************************************************************/

#include "bodyfat.h"

/*********************************************************************************************
* 定义
*********************************************************************************************/
#define NUMBER  8
#define AGE     5.15819e-10
int AD5993_Scan(short *buf);

/*********************************************************************************************
* 名称：void bodyfat_init(void)
* 功能：身体脂肪函数初始化
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
void bodyfat_init(void)
{
    AD5993_Init();
    AD5993_Start_F(30000);
    AD5993_Add_F(100);
    AD5993_Add_N(NUMBER-1);
    AD5993_Start_Delay_T(32);
}

/*********************************************************************************************
* 名称：float bodyfat_alg(void)
* 功能：身体脂肪函数
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
float bodyfat_alg(void)
{
    signed short buf[NUMBER*2];
    int ret;
    ret = AD5993_Scan(buf);                                       //脂肪检测
    //printf("--------------------------\r\n");
    double s = 0;
    for (int i=0; i<ret; i++)
    {
        int a = buf[2*i]*buf[2*i] + buf[2*i+1]*buf[2*i+1];
        float t = sqrt(a);                                          //开根号
        s += t;
        //printf(" %d, %d , %.2f\r\n", buf[2*i], buf[2*i+1], t);
    }
    s = s / ret;
    double r = 1/(AGE * s);
    /*   90000   - 10
     *   95000   - 15
     *   96000   - 19
     *  110000   - 24
     */
    //printf(" R = %.1f\r\n", r);
    r = 15 + (r-95000) /((110000 - 95000) / (float)(24 - 15));    //计算脂肪
    //printf(" a = %.1f\r\n", r);
    if(r < 100)
        return r;
    else
        return 0;
}